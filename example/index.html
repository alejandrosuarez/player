<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proton Player</title>
    <script src="../dist/proton-player.umd.js"></script>
  </head>
  <body>
    <div id="container" style="display: flex; flex-direction: column;">
      <input
        id="stop-btn"
        class="btn"
        type="button"
        value="Stop"
        style="background-color: #ff4e33; border: none; color: #000; padding: 16px 32px; text-decoration: none; margin: 4px 2px; cursor: pointer;"
        disabled
      />
      <input
        id="pause-btn"
        class="btn"
        type="button"
        value="Pause"
        style="background-color: #ffe662; border: none; color: #000; padding: 16px 32px; text-decoration: none; margin: 4px 2px; cursor: pointer;"
        disabled
      />
    </div>
    <h5>Buffered:</h5>
    <div
      id="buffer-display"
      style="width:100%; height:10px; border:1px solid black;"
    ></div>
    <h5>Playback Position (use it to seek!):</h5>
    <div
      id="playback-position-display"
      style="width:100%; height:10px; border:1px solid black;"
    ></div>
    <h5 id="audio-engine-text" style="width: 100%; text-align: center;"></h5>
    <audio autoplay>
      Your browser doesn't support HTML audio element.
    </audio>
    <script>
      const onReady = () => {
        const $audioEngineText = document.getElementById("audio-engine-text");
        if (typeof window.MediaSource !== "undefined") {
          $audioEngineText.textContent = "Using MediaSource API";
        } else {
          $audioEngineText.textContent = "Using AudioContext API";
        }

        const $btns = document.getElementsByClassName("btn");
        for (let $btn of $btns) {
          $btn.removeAttribute("disabled");
        }
      };
      const onError = err => {
        console.error(err);
      };

      const player = new ProtonPlayer(onReady, onError);

      const $container = document.getElementById("container");
      const $stopBtn = document.getElementById("stop-btn");
      $stopBtn.onclick = function() {
        player.disposeAll();
        const $playBtns = document.getElementsByClassName("play-btn");
        for (const $btn of $playBtns) {
          $btn.preloaded = false;
          $btn.setAttribute(
            "value",
            $btn.value.replace(" (preloaded)", "").replace(" (loading...)", "")
          );
        }
      };
      const $pauseBtn = document.getElementById("pause-btn");
      $pauseBtn.onclick = function() {
        player.pauseAll();
      };
      const $bufferDisplay = document.getElementById("buffer-display");
      const $playbackPositionDisplay = document.getElementById(
        "playback-position-display"
      );
      $playbackPositionDisplay.onclick = function(event) {
        const percent =
          (event.pageX - event.currentTarget.offsetLeft) /
          event.currentTarget.offsetWidth;
        player.setPlaybackPosition(percent);
      };

      function init() {
        const baseURL = "http://local.protonradio.com:3003";
        const token =
          "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjozMDMyMjIsInBocGJiX3VzZXIiOnsidXNlcm5hbWUiOiJjaGFybGVzbmF2aSIsInVzZXJfYWN0aXZlIjp0cnVlLCJhdXRoZW50aWNhdGlvbl90b2tlbiI6IkJ6WWZpUU53SzdVY0g5TDNGaHBFIiwicHJvdG9uX3N1YnNjcmliZSI6dHJ1ZX0sInVzZXIiOnsiaWQiOjI4NjY4LCJhY2Nlc3NsZXZlbCI6M30sImV4cCI6MTU2NzcxNTY4NywiaWF0IjoxNTY3NjI5Mjg3fQ.tXapKEjTqkUqqU6D6Q08w6ySulg2Hw5yQGXcayQAeEk";
        [
          {
            name: "Track 1",
            url: `${baseURL}/single?fn=mp3-128%2F943054_282276_Domuyo_Original_Mix_128k.mp3&md5=D2DqeRKTYGBJfcvPbLTGAQ%3D%3D&player_id=1559854170445&token=${token}`,
            size: 7743110,
            preLoad: true
          },
          {
            name: "Track 2",
            url: `${baseURL}/single?fn=mp3-128%2F936950_299413_Catharsis_Original_Mix_128k.mp3&md5=ArYcPsajrGKmnQm%2FD6WCuQ%3D%3D&player_id=1559854235788&token=${token}`,
            size: 7809148,
            preLoadOnHover: true
          },
          {
            name: "Track 3",
            url: `${baseURL}/single?fn=mp3-128%2F939476_292726_Geometria_Original_Mix_128k.mp3&md5=X4uzvwtej2z0pQ0XplZKIQ%3D%3D&player_id=1559854500653&token=${token}`,
            size: 7083153
          },
          {
            name: "Mix 1",
            url: `${baseURL}/stream?fn=1063013_Syncopation_%282019-05-14%29_Part_1_-_Christopher_FaFa_-_Syncopation.mp3&md5=m2eNR7trmNZaVvkerJ%2BEvg%3D%3D&player_id=1559854282509&token=${token}`,
            size: 82396054,
            preLoad: true
          },
          {
            name: "Mix 2",
            url: `${baseURL}/stream?fn=1069804_Visceral_%282019-05-24%29_Part_2_-_James_Warren.mp3&md5=axd6vSbE54P6JfLddms%2Fjg%3D%3D&player_id=1559854370708&token=${token}`,
            size: 82787264,
            preLoadOnHover: true
          },
          {
            name: "Mix 3",
            url: `${baseURL}/stream?fn=1069805_Audioholics_%282019-05-24%29_Part_1_-_Mariano_Mellino_-_Audioholics_Episode_48_by_Mariano_Mellino_.mp3&md5=vlhwzMUpCOwinq8IFku6AA%3D%3D&player_id=1559854549060&token=${token}`,
            size: 85516328
          }
        ].forEach(file => {
          const $btn = document.createElement("input");
          $btn.setAttribute("class", "btn play-btn");
          $btn.setAttribute("type", "button");
          $btn.setAttribute(
            "value",
            file.preLoad ? `${file.name} (loading...)` : file.name
          );
          $btn.setAttribute("disabled", file.preLoad ? "disabled" : "");
          $btn.setAttribute(
            "style",
            "background-color: #000; border: none; color: white; padding: 16px 32px; text-decoration: none; margin: 4px 2px; cursor: pointer;"
          );

          const { url, size, preLoad, preLoadOnHover } = file;

          if (preLoad) {
            player.preLoad(url, size).then(() => {
              $btn.removeAttribute("disabled");
              $btn.setAttribute("value", file.name + " (preloaded)");
            });
          }

          if (preLoadOnHover) {
            $btn.onmouseover = function() {
              if ($btn.preloaded) return;
              $btn.preloaded = true;

              $btn.setAttribute("value", `${file.name} (loading...)`);

              player.preLoad(url, size).then(() => {
                $btn.removeAttribute("disabled");
                $btn.setAttribute("value", file.name + " (preloaded)");
              });
            };
          }

          $btn.onclick = function() {
            /*
            background: -webkit-linear-gradient(left, #efe3af 75%,#ffffff 75%);
            background:    -moz-linear-gradient(left, #efe3af 75%, #ffffff 75%);
            background:     -ms-linear-gradient(left, #efe3af 75%,#ffffff 75%);
            background:      -o-linear-gradient(left, #efe3af 75%,#ffffff 75%);
            background:         linear-gradient(to right, #efe3af 75%,#ffffff 75%);
            */
            const onBufferProgress = (initialPosition, progress) => {
              const start = Math.min(initialPosition, 1) * 100;
              const end = Math.min(progress, 1) * 100;
              $bufferDisplay.style.background = `linear-gradient(
                to right,
                white, white ${start}%,
                #efe3af ${start}%, #efe3af ${end}%,
                white ${end}%, white ${end}%
              )`;
            };
            const onPlaybackProgress = progress => {
              const percent = Math.min(progress, 1) * 100;
              $playbackPositionDisplay.style.background = `linear-gradient(to right, #efe3af ${percent}%, #ffffff ${percent}%)`;
            };
            player.play(url, size, onBufferProgress, onPlaybackProgress);
          };

          $container.appendChild($btn);
        });
      }

      init();
    </script>
  </body>
</html>
